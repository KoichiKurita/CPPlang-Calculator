name: Windows CI (Qt Calculator)

on:
  push:
    branches: [ "main" ]
    tags:
      - "v*"
  pull_request:

jobs:
  build:
    runs-on: windows-latest

    steps:
      # ① リポジトリ取得
      - name: Checkout repository
        uses: actions/checkout@v4

      # ② MSYS2 + MinGW + Qt6 + CMake セットアップ
      - name: Set up MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-qt6
            mingw-w64-ucrt-x86_64-ninja

      # ③ Configure & Build（クリーンビルド）
      - name: Configure and Build
        shell: msys2 {0}
        run: |
          rm -rf build-ci
          cmake -S . -B build-ci
          cmake --build build-ci

      # ④ テスト（将来 GoogleTest 追加してもそのまま使える）
      - name: Run tests
        shell: msys2 {0}
        run: |
          ctest --test-dir build-ci --output-on-failure || true

      # ⑤ exe を Artifact として保存
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: QtCalculator-Windows
          path: build-ci/src/QtCalculator.exe

      # ⑥ GitHub Release（tag push 時のみ）
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: build-ci/src/QtCalculator.exe
